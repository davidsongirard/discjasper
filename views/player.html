<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Clique Play > Music Player</title>
    <link href="main.css" rel="stylesheet"/>
  </head>
  <body class="player">
    <div class="yt" id="player"></div>
    <script src="https://cdn.socket.io/socket.io-1.0.6.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      var twitter = window.location.pathname;
      var socket = io.connect("localhost:5000");
      var player;

      socket.on('connect', function () {
        console.log("connected to server");
        socket.emit("USE", twitter); 
        findNext();
      });

      function findNext() {
        socket.emit("next_song",{});
        console.log("requesting new song");
      }

      function playVideo(obj) {
        if (player) player.loadVideoById(obj.id, 0, "large");
        console.log("player" +obj.id);
      }

      socket.on('next_song', function(obj) {
        console.log("got new song");
        playVideo(obj);
      });

      socket.on('stop_song', function(obj) {
        stopPlayer();
      });

      socket.on('play_song', function(obj) {
        playPlayer();
      });

      socket.on('disconnect', function () {
        console.log("disconnected from server") 
      });

      // Only the player responds to the player_check
      // If no player found next client is nominated
      socket.on('player_marco', function () {
        console.log("heard a marco, responding with a polo");
        socket.emit("player_polo",{});
      });

      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          videoId: "lO45DNkBMi4", // loading animation video
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      var ignore = false;
      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
          socket.emit("play_song",{"from":"video"}); 
        } 

        if (event.data == YT.PlayerState.PAUSED) {
          socket.emit("stop_song",{"from":"video"}); 
        } 

        if (event.data == YT.PlayerState.ENDED) {
          console.log("video finished playing");
          findNext();
        }
      }

      function stopPlayer() {
        if(player) player.pauseVideo();
      }

      function playPlayer() {
        if(player) player.playVideo();
      }

    </script>
  </body>
</html>
